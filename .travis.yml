language: ruby
sudo: required
services:
  - docker
stages:
  - pull
  - build
  - push
jobs:
  include:
    - stage: pull
      script:
        - pip install --user awscli
        - export PATH=$PATH:$HOME/.local/bin # put aws in the path
        - eval $(aws ecr get-login --region us-east-1 --registry-ids 763104351884 --no-include-email )
        - docker pull 763104351884.dkr.ecr.us-east-1.amazonaws.com/tensorflow-inference:1.14.0-cpu
    - stage: build
      before_install:
        - cd sagemaker
        - docker build -t $AWS_ECR_REPO_URI:1.0 -f Dockerfile .
      script:
        - docker run $AWS_ECR_REPO_URI:1.0 /bin/bash -c "apt list --installed; python --version; pip list; python -c 'import cv2'; python -c 'import tensorflow as tf'"
        - eval $(aws ecr get-login --region us-east-1)
        - docker push $AWS_ECR_REPO_URI:1.0