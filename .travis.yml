language: ruby

sudo: required

services:
  - docker

before_install:
  - pip install --user awscli
  - export PATH=$PATH:$HOME/.local/bin # put aws in the path
  - eval $(aws ecr get-login --region us-east-1 --registry-ids 763104351884 --no-include-email )

install:
  - docker pull 763104351884.dkr.ecr.us-east-1.amazonaws.com/tensorflow-inference:1.14.0-cpu
  - docker run 763104351884.dkr.ecr.us-east-1.amazonaws.com/tensorflow-inference:1.14.0-cpu python3 -c "import tensorflow as tf; print(tf.__version__)"
  - docker run 763104351884.dkr.ecr.us-east-1.amazonaws.com/tensorflow-inference:1.14.0-cpu /bin/bash -c "cat /usr/bin/tf_serving_entrypoint.sh"

before_script:
  - cd sagemaker

script:
  - docker build -t $AWS_ECR_REPO_URI:1.0 -f cpu.Dockerfile .
  - docker run $AWS_ECR_REPO_URI:1.0 /bin/bash -c "cat /usr/bin/tf_serving_entrypoint.sh"
  - docker run $AWS_ECR_REPO_URI:1.0 python3 -c "import tensorflow as tf; print(tf.__version__)"
  - docker run $AWS_ECR_REPO_URI:1.0 python3 -c "import cv2; print(cv2.__version__)"
  - docker run $AWS_ECR_REPO_URI:1.0 python3 -c "import pkg_resources; print(list(pkg_resources.working_set))"

after_script:
  - eval $(aws ecr get-login --region us-east-1)
  - docker push $AWS_ECR_REPO_URI:1.0